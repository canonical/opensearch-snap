#!/usr/bin/env bash

set -eux


source "${OPS_ROOT}"/helpers/snap-logger.sh "hook-install"
source "${OPS_ROOT}"/helpers/io.sh
source "${OPS_ROOT}"/helpers/set-conf.sh

function create_file_structure () {
    mkdir -p "${OPENSEARCH_PATH_CONF}"
    mkdir -p "${OPENSEARCH_HOME}"
    mkdir -p "${OPENSEARCH_VARLIB}"
    mkdir -p "${OPENSEARCH_VARLOG}"
    mkdir -p "${OPENSEARCH_TMPDIR}"
    mkdir -p "${OPENSEARCH_PATH_CERTS}"
    mkdir -p "${OPENSEARCH_LIB}"
    # Create a dummy /bin folder otherwise OpenSearch will try to do it:
    # https://github.com/opensearch-project/OpenSearch/blob/db838c4ca090103a8ba562b3cb124044be725c62/
    #      server/src/main/java/org/opensearch/bootstrap/Security.java#L315
    mkdir -p "${OPENSEARCH_HOME}"/bin

    cp -n -r "${SNAP}"/usr/share/opensearch/config/* "${OPENSEARCH_PATH_CONF}"
    chmod -R 755 "${OPENSEARCH_PATH_CONF}"
}


function set_base_config_props () {
    # Change conf to set log and data paths for both opensearch.yaml and jvm.options
    #     More info, check: https://github.com/opensearch-project/OpenSearch/blob/  \
    #     418ab51718cb68b7a57d4cf524b1dec9ed02b224/server/src/main/java/org/opensearch/env/Environment.java#L68
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.data" "${OPENSEARCH_VARLIB}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "node.pidfile" "${OPENSEARCH_PATH_CONF}"/pidfile
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.logs" "${OPENSEARCH_VARLOG}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.home" "${OPENSEARCH_HOME}"

    # For a module or plugin to be loaded, their class must be specified in the java classpath and their
    # properties and security policy must be present in a folder. Build the folder with all the modules.
    # File path described in:
    #    https://github.com/opensearch-project/OpenSearch/blob/418ab51718cb68b7a57d4cf524b1dec9ed02b224/  \
    #    server/src/main/java/org/opensearch/plugins/PluginInfo.java#L64
    mkdir -p "${OPENSEARCH_HOME}"/modules
    mkdir -p "${OPENSEARCH_HOME}"/plugins
    mkdir -p "${OPENSEARCH_HOME}"/extensions
    cp -n -r "${SNAP}"/usr/share/opensearch/modules/* "${OPENSEARCH_HOME}"/modules
    cp -n -r "${SNAP}"/usr/share/opensearch/plugins/* "${OPENSEARCH_HOME}"/plugins

    cp -n -r "${SNAP}"/usr/share/opensearch/lib/* "${OPENSEARCH_LIB}"

    sed -i s@=logs/@"=${OPENSEARCH_VARLOG}"@ "${OPENSEARCH_PATH_CONF}/jvm.options"
}


create_file_structure
set_base_config_props

# Set final permissions
# Following recommendation from: https://forum.snapcraft.io/t/system-usernames/13386/7
# SNAP_DATA: daemon can only read its content; users can write in it IF having root permission
# SNAP_COMMON: daemon and users can read and write on it
set_access_restrictions "${SNAP_COMMON}"/* 770

# Set daemon user to have access to these folders
set_access_restrictions "${OPENSEARCH_HOME}"/bin
# OpenSearch needs write access to the path conf so it can write the keystore file
set_access_restrictions "${OPENSEARCH_PATH_CONF}" 770
