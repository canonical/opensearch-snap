#!/usr/bin/env bash

set -eu


source "${OPS_ROOT}"/helpers/snap-logger.sh "hook-install"
source "${OPS_ROOT}"/helpers/io.sh
source "${OPS_ROOT}"/helpers/set-conf.sh

function create_file_structure () {
    file_copy etc/opensearch/. "${OPENSEARCH_PATH_CONF}" 770
    declare -a folders=("${OPENSEARCH_HOME}" "${OPENSEARCH_HOME}"/bin "${OPENSEARCH_VARLIB}" "${OPENSEARCH_VARLOG}" "${OPENSEARCH_TMPDIR}" "${OPENSEARCH_PATH_CERTS}")
    for f in "${folders[@]}"; do
        add_folder $f 770
    done
}


function set_base_config_props () {
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.data" "${OPENSEARCH_VARLIB}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "node.pidfile" "${OPENSEARCH_PATH_CONF}"/pidfile
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.logs" "${OPENSEARCH_VARLOG}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.home" "${OPENSEARCH_HOME}"

    mkdir -p "${OPENSEARCH_HOME}"/modules
    mkdir -p "${OPENSEARCH_HOME}"/plugins
    mkdir -p "${OPENSEARCH_HOME}"/extensions
    mkdir -p "${OPENSEARCH_LIB}"
    cp -n -r "${SNAP}"/usr/share/opensearch/modules/* "${OPENSEARCH_HOME}"/modules
    cp -n -r "${SNAP}"/usr/share/opensearch/plugins/* "${OPENSEARCH_HOME}"/plugins
    cp -n -r "${SNAP}"/usr/share/opensearch/lib/* "${OPENSEARCH_LIB}"
}


create_file_structure
set_base_config_props
