#!/usr/bin/env bash

set -eux


source "${OPS_ROOT}"/helpers/snap-logger.sh "hook-install"
source "${OPS_ROOT}"/helpers/io.sh
source "${OPS_ROOT}"/helpers/set-conf.sh

function create_file_structure () {
    declare -a folders=("${OPENSEARCH_HOME}" "${OPENSEARCH_PATH_CONF}" "${OPENSEARCH_HOME}"/bin "${OPENSEARCH_VARLIB}" "${OPENSEARCH_VARLOG}" "${OPENSEARCH_TMPDIR}" "${OPENSEARCH_PATH_CERTS}")
    for f in "${folders[@]}"; do
        add_folder $f 770
    done
}


function set_base_config_props () {
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.data" "${OPENSEARCH_VARLIB}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "node.pidfile" "${OPENSEARCH_PATH_CONF}"/pidfile
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.logs" "${OPENSEARCH_VARLOG}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.home" "${OPENSEARCH_HOME}"

    mkdir -p "${OPENSEARCH_HOME}"/modules
    mkdir -p "${OPENSEARCH_HOME}"/plugins
    mkdir -p "${OPENSEARCH_HOME}"/extensions
    mkdir -p "${OPENSEARCH_LIB}"
    cp -n -r "${SNAP}"/usr/share/opensearch/modules/* "${OPENSEARCH_HOME}"/modules
    cp -n -r "${SNAP}"/usr/share/opensearch/plugins/* "${OPENSEARCH_HOME}"/plugins
    cp -n -r "${SNAP}"/usr/share/opensearch/lib/* "${OPENSEARCH_LIB}"

    sed -i s@=logs/@"=${OPENSEARCH_VARLOG}"@ "${OPENSEARCH_PATH_CONF}/jvm.options"
}


create_file_structure
set_base_config_props

# Set final permissions
# Following recommendation from: https://forum.snapcraft.io/t/system-usernames/13386/7
# SNAP_DATA: daemon can only read its content; users can write in it IF having root permission
# SNAP_COMMON: daemon and users can read and write on it
# set_access_restrictions expect one single folder, so iterate over folders under SNAP_COMMON
for d in $(ls "${SNAP_COMMON}"); do
	set_access_restrictions "${SNAP_COMMON}"/"$d" 770
done
