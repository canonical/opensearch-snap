#!/usr/bin/env bash

set -eux


source "${OPS_ROOT}"/helpers/snap-logger.sh "hook-install"
source "${OPS_ROOT}"/helpers/io.sh
source "${OPS_ROOT}"/helpers/set-conf.sh

function create_file_structure () {
#    add_folder "${SNAP_COMMON}/backups" 774
#    ls -la "${SNAP_COMMON}"
#    ls -la "${SNAP_COMMON}/backups"
#    dir_copy_if_not_exists "config" "${SNAP_COMMON}/backups" 774

    # -------------------------------

    #add_folder "${OPENSEARCH_PATH_CONF}" 770
    #add_folder "${OPENSEARCH_HOME}" 770

    mkdir -p "${OPENSEARCH_PATH_CONF}"
    mkdir -p "${OPENSEARCH_HOME}"
    mkdir -p "${OPENSEARCH_VARLIB}"
    mkdir -p "${OPENSEARCH_VARLOG}"
    mkdir -p "${OPENSEARCH_TMPDIR}"
    mkdir -p "${OPENSEARCH_PATH_CERTS}"
    mkdir -p "${OPENSEARCH_PATH_CONF}/extensions"
    mkdir -p "${SNAP_COMMON}/backups"

#    cp -R -n -r -p "${SNAP}/modules" "${SNAP}/plugins" "${OPENSEARCH_HOME}"
#    cp -R -n -r -p "${SNAP}/plugins" "${OPENSEARCH_HOME}"
#    cp -R -n -r -p "${SNAP}"/config/* "${OPENSEARCH_PATH_CONF}"

    chmod -R 770 "${SNAP_DATA}"/*
    chmod -R 770 "${SNAP_COMMON}"/*
    chown -R snap_daemon "${SNAP_DATA}"/*
    chown -R snap_daemon "${SNAP_COMMON}"/*


    "${SNAP}"/usr/bin/setpriv \
        --clear-groups \
        --reuid snap_daemon \
        --regid snap_daemon -- \
        cp -R -n -r -p "${SNAP}"/config/* "${OPENSEARCH_PATH_CONF}"
    "${SNAP}"/usr/bin/setpriv \
        --clear-groups \
        --reuid snap_daemon \
        --regid snap_daemon -- \
        cp -R -n -r -p "${SNAP}/modules" "${SNAP}/plugins" "${OPENSEARCH_HOME}" 
}


function set_base_config_props () {
    # Change conf to set log and data paths for both opensearch.yaml and jvm.options
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.data" "${OPENSEARCH_VARLIB}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.logs" "${OPENSEARCH_VARLOG}"

    replace_in_file "${OPENSEARCH_PATH_CONF}/jvm.options" "=logs/" "=${OPENSEARCH_VARLOG}"
}


create_file_structure
set_base_config_props
