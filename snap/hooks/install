#!/usr/bin/env bash

set -eu


source "${OPS_ROOT}"/helpers/snap-logger.sh "hook-install"
source "${OPS_ROOT}"/helpers/io.sh
source "${OPS_ROOT}"/helpers/set-conf.sh

function create_file_structure () {
    file_copy etc/opensearch/. "${OPENSEARCH_PATH_CONF}" 770
    declare -a folders=("${OPENSEARCH_HOME}" "${OPENSEARCH_HOME}"/bin "${OPENSEARCH_VARLIB}" "${OPENSEARCH_VARLOG}" "${OPENSEARCH_TMPDIR}" "${OPENSEARCH_PATH_CERTS}")
    for f in "${folders[@]}"; do
        add_folder $f 770
    done

    declare -a common=(modules plugins lib)
    for dir in "${common[@]}"; do
        file_copy usr/share/opensearch/"${dir}"/. "${OPENSEARCH_HOME}/${dir}" 770
    done
    add_folder "${OPENSEARCH_HOME}"/extensions 770
}


function set_base_config_props () {
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.data" "${OPENSEARCH_VARLIB}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "node.pidfile" "${OPENSEARCH_PATH_CONF}"/pidfile
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.logs" "${OPENSEARCH_VARLOG}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.home" "${OPENSEARCH_HOME}"
}


create_file_structure
set_base_config_props
