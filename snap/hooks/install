#!/usr/bin/env bash

set -eux


source "${OPS_ROOT}"/helpers/snap-logger.sh "hook-install"
source "${OPS_ROOT}"/helpers/io.sh
source "${OPS_ROOT}"/helpers/set-conf.sh


function create_file_structure () {
    # Opensearch install folders and set config
    dir_copy_if_not_exists "bin" "${SNAP_DATA}" 774
    dir_copy_if_not_exists "jdk" "${SNAP_DATA}" 774
    dir_copy_if_not_exists "lib" "${SNAP_DATA}" 554
    dir_copy_if_not_exists "modules" "${SNAP_DATA}" 554
    dir_copy_if_not_exists "plugins" "${SNAP_DATA}" 774

    dir_copy_if_not_exists "config" "${SNAP_DATA}" 774
    add_folder "${SNAP_DATA}/config/certificates" 774
    add_file "${SNAP_DATA}/config/unicast_hosts.txt" 774

    add_folder "${SNAP_DATA}/extensions" 774
    add_file "${SNAP_DATA}/extensions/extensions.yml" 774

    add_folder "${SNAP_COMMON}/data" 774
    add_folder "${SNAP_COMMON}/logs" 774
    add_folder "${SNAP_COMMON}/tmp" 774

    # performance analyzer
    mkdir -p "/dev/shm/snap.${SNAP_INSTANCE_NAME}/performanceanalyzer/"
    chmod -R 777 "/dev/shm/snap.${SNAP_INSTANCE_NAME}/performanceanalyzer/"
}


function set_base_config_props () {
    # Change conf to set log and data paths for both opensearch.yaml and jvm.options
    set_yaml_prop "${SNAP_DATA}/config/opensearch.yml" "path.data" "${SNAP_COMMON}/data"
    set_yaml_prop "${SNAP_DATA}/config/opensearch.yml" "path.logs" "${SNAP_COMMON}/logs"

    replace_in_file "${SNAP_DATA}/config/jvm.options" "=logs/" "=${SNAP_COMMON}/logs/"
}


function set_performance_analyzer_path () {
    # change path of the metrics location directory of the performance analyzer
    replace_in_file \
        "${SNAP_DATA}/config/opensearch-performance-analyzer/performance-analyzer.properties" \
        "metrics-location = /dev/shm/performanceanalyzer/" \
        "metrics-location = /dev/shm/snap.${SNAP_INSTANCE_NAME}/performanceanalyzer/"
}


create_file_structure
set_base_config_props

set_performance_analyzer_path
