#!/usr/bin/env bash

set -eux


source "${OPS_ROOT}"/helpers/snap-logger.sh "hook-install"
source "${OPS_ROOT}"/helpers/io.sh
source "${OPS_ROOT}"/helpers/set-conf.sh

function create_file_structure () {
    mkdir -p "${OPENSEARCH_PATH_CONF}"
    mkdir -p "${OPENSEARCH_HOME}"
    mkdir -p "${OPENSEARCH_VARLIB}"
    mkdir -p "${OPENSEARCH_VARLOG}"
    mkdir -p "${OPENSEARCH_TMPDIR}"
    mkdir -p "${OPENSEARCH_PATH_CERTS}"

    cp -n -r "${SNAP}"/config/* "${OPENSEARCH_PATH_CONF}"
}


function set_base_config_props () {
    # Change conf to set log and data paths for both opensearch.yaml and jvm.options
    #     More info, check: https://github.com/opensearch-project/OpenSearch/blob/  \
    #     418ab51718cb68b7a57d4cf524b1dec9ed02b224/server/src/main/java/org/opensearch/env/Environment.java#L68
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.data" "${OPENSEARCH_VARLIB}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "node.pidfile" "${OPENSEARCH_HOME}"/pidfile
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.logs" "${OPENSEARCH_VARLOG}"
    set_yaml_prop "${OPENSEARCH_PATH_CONF}/opensearch.yml" "path.home" "${OPENSEARCH_HOME}"

    # For a module or plugin to be loaded, their class must be specified in the java classpath and their
    # properties and security policy must be present in a folder. Build the folder with all the modules.
    # File path described in:
    #    https://github.com/opensearch-project/OpenSearch/blob/418ab51718cb68b7a57d4cf524b1dec9ed02b224/  \
    #    server/src/main/java/org/opensearch/plugins/PluginInfo.java#L64
    mkdir -p "${OPENSEARCH_HOME}"/modules
    mkdir -p "${OPENSEARCH_HOME}"/plugins
    mkdir -p "${OPENSEARCH_HOME}"/extensions
    cp -n -r "${OPENSEARCH_MODULES}"/* "${OPENSEARCH_HOME}"/modules
    cp -n -r "${OPENSEARCH_PLUGINS}"/* "${OPENSEARCH_HOME}"/plugins

    sed -i s@=logs/@"=${OPENSEARCH_VARLOG}"@ "${OPENSEARCH_PATH_CONF}/jvm.options"
}


create_file_structure
set_base_config_props

# Set final permissions
# Following recommendation from: https://forum.snapcraft.io/t/system-usernames/13386/7
chmod -R 770 "${SNAP_DATA}"/*
chmod -R 770 "${SNAP_COMMON}"/*
chown -R snap_daemon "${SNAP_DATA}"/*
chown -R snap_daemon "${SNAP_COMMON}"/*
chgrp root "${SNAP_DATA}"/*
chgrp root "${SNAP_COMMON}"/*
