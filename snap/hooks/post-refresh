#!/usr/bin/env bash

set -eux

OLD_SNAP_DATA=$(cat "${SNAP_COMMON}"/on_refresh_snap)
rm -f "${SNAP_COMMON}"/on_refresh_snap

for i in $(find "${OPENSEARCH_PATH_CONF}" -type f); do
	# Some files may have been created by snap_daemon and then, will cause permission denied
	if sed "s@${OLD_SNAP_DATA}@${SNAP_DATA}@g" $i > "$SNAP_DATA"/temp_sed_file; then
		cat "$SNAP_DATA"/temp_sed_file > $i
	fi
done

rm -f "$SNAP_DATA"/temp_sed_file
# Clean old SNAP_DATA lib,plugins and modules, as we've copied the jars to the new folder already
mv "${SNAP_COMMON}"/in_upgrade/lib "${SNAP_DATA}"/usr/share/opensearch/lib
mv "${SNAP_COMMON}"/in_upgrade/modules "${SNAP_DATA}"/usr/share/opensearch/modules
mv "${SNAP_COMMON}"/in_upgrade/plugins "${SNAP_DATA}"/usr/share/opensearch/plugins

rm -rf "${SNAP_COMMON}"/in_upgrade
